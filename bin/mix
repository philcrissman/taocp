#!/usr/bin/env ruby
# frozen_string_literal: true

require "bundler/setup"
require_relative "../lib/taocp"

# CLI entrypoint for MIX/MIXAL interpreter
# Usage:
#   mix assemble input.mixal -o output.mix
#   mix run program.mix
#   mix exec program.mixal

if ARGV.empty? || ARGV.include?("--help") || ARGV.include?("-h")
  puts <<~HELP
    MIX/MIXAL Interpreter - Part of the Quackers gem

    Usage:
      mix assemble <file.mixal> [-o output]  Assemble MIXAL to binary
      mix run <file.mix>                     Run assembled MIX program
      mix exec <file.mixal>                  Assemble and run MIXAL program
      mix --help                             Show this help

    Examples:
      mix assemble hello.mixal -o hello.mix
      mix run hello.mix
      mix exec hello.mixal
  HELP
  exit 0
end

command = ARGV[0]

case command
when "assemble"
  if ARGV.length < 2
    puts "Error: No input file specified"
    puts "Usage: mix assemble <file.mixal> [-o output]"
    exit 1
  end

  input_file = ARGV[1]
  unless File.exist?(input_file)
    puts "Error: File not found: #{input_file}"
    exit 1
  end

  # Read source
  source = File.read(input_file)

  # Assemble
  begin
    assembler = Taocp::Mixal::Assembler.new
    assembler.assemble(source)

    # Get output filename
    output_file = nil
    if idx = ARGV.index("-o")
      output_file = ARGV[idx + 1]
    else
      output_file = input_file.sub(/\.mixal$/i, ".mix")
    end

    # Save assembled program (marshal the memory)
    File.open(output_file, "wb") do |f|
      Marshal.dump({
        memory: assembler.memory,
        start_address: assembler.start_address,
        symbols: assembler.symbol_table
      }, f)
    end

    puts "✓ Assembled #{input_file} -> #{output_file}"
    puts "  Start address: #{assembler.start_address || 0}"
    puts "  Symbol count: #{assembler.symbol_table.all_symbols.size}"
  rescue Taocp::Mixal::Error => e
    puts "Assembly error: #{e.message}"
    exit 1
  end

when "run"
  if ARGV.length < 2
    puts "Error: No input file specified"
    puts "Usage: mix run <file.mix>"
    exit 1
  end

  input_file = ARGV[1]
  unless File.exist?(input_file)
    puts "Error: File not found: #{input_file}"
    exit 1
  end

  # Load assembled program
  begin
    data = File.open(input_file, "rb") { |f| Marshal.load(f) }

    # Create machine and load program
    machine = Taocp::Mix::Machine.new
    (0...4000).each do |addr|
      machine.memory[addr] = data[:memory][addr]
    end
    machine.pc = data[:start_address] || 0

    # Run
    puts "Running #{input_file}..."
    inst_count = machine.run
    puts "✓ Halted after #{inst_count} instructions"

    # Show final state
    puts "\nFinal registers:"
    puts "  A  = #{machine.registers.a.to_i}"
    puts "  X  = #{machine.registers.x.to_i}"
    puts "  I1 = #{machine.registers.get_index_i(1)}"
    puts "  I2 = #{machine.registers.get_index_i(2)}"
    puts "  I3 = #{machine.registers.get_index_i(3)}"
  rescue Taocp::Mix::Error => e
    puts "Runtime error: #{e.message}"
    exit 1
  end

when "exec"
  if ARGV.length < 2
    puts "Error: No input file specified"
    puts "Usage: mix exec <file.mixal>"
    exit 1
  end

  input_file = ARGV[1]
  unless File.exist?(input_file)
    puts "Error: File not found: #{input_file}"
    exit 1
  end

  # Read and assemble
  source = File.read(input_file)
  begin
    assembler = Taocp::Mixal::Assembler.new
    assembler.assemble(source)

    puts "Assembling #{input_file}..."
    puts "  Start address: #{assembler.start_address || 0}"

    # Create machine and load program
    machine = Taocp::Mix::Machine.new
    (0...4000).each do |addr|
      machine.memory[addr] = assembler.memory[addr]
    end
    machine.pc = assembler.start_address || 0

    # Run
    puts "Running..."
    inst_count = machine.run
    puts "✓ Halted after #{inst_count} instructions"

    # Show output if any
    if machine.output.any?
      puts "\nOutput:"
      puts "-" * 60
      machine.output.each { |line| puts line }
      puts "-" * 60
    end

    # Show final state
    puts "\nFinal registers:"
    puts "  A  = #{machine.registers.a.to_i}"
    puts "  X  = #{machine.registers.x.to_i}"
    puts "  I1 = #{machine.registers.get_index_i(1)}"
    puts "  I2 = #{machine.registers.get_index_i(2)}"
    puts "  I3 = #{machine.registers.get_index_i(3)}"
    puts "  I4 = #{machine.registers.get_index_i(4)}"
    puts "  I5 = #{machine.registers.get_index_i(5)}"
    puts "  I6 = #{machine.registers.get_index_i(6)}"
    puts "  J  = #{machine.registers.j}"
  rescue Taocp::Mixal::Error => e
    puts "Assembly error: #{e.message}"
    exit 1
  rescue Taocp::Mix::Error => e
    puts "Runtime error: #{e.message}"
    exit 1
  end

else
  puts "Unknown command: #{command}"
  puts "Run 'mix --help' for usage information"
  exit 1
end
